{"version":3,"sources":["../src/datasource.js"],"names":["IronDbCheckDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","checkUuid","jsonData","minRollup","parseInt","headers","basicAuth","length","cache","metrics","timestamp","doRequest","method","then","response","status","Error","data","message","title","error","console","query","kind","debug","now","Date","getTime","log","toISOString","Promise","resolve","metric","match","uuid","group","push","options","interval","intervalMs","start","range","from","valueOf","end","to","Math","round","floor","ceil","promises","targets","target","replace","scopedVars","fetchData","all","annotation","regionId","previousTrue","entry","object","time","text","encodeURIComponent","multiplier","result","datapoints","datasourceRequest","_","filter","map","refId","hide"],"mappings":"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","sourcesContent":["import _ from \"lodash\";\n\nexport class IronDbCheckDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.checkUuid = instanceSettings.jsonData\n                  && instanceSettings.jsonData.checkUuid\n                  || '00000000-0000-0000-0000-000000000000';\n    this.minRollup = parseInt(instanceSettings.jsonData.minRollup) || 30;\n    this.headers = {'Content-Type': 'application/json'};\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n\n    this.cache = {\n      metrics: null,\n      timestamp: 0\n    };\n  }\n\n  /* Test our datasource, we must have at least one metric for it to be successful */\n  testDatasource() {\n    return this.doRequest({\n      url: this.url + '/raw/list_metrics',\n      method: 'GET'\n    }).then((response) => {\n      if (response.status != 200) throw new Error('Invalid status code ' + response.status);\n      if (response.data && response.data.length) {\n        return { status: \"success\", message: \"Data source has \" + response.data.length + \" metrics\", title: \"Success\" };\n      } else {\n        throw new Error('No metrics found for check ' + this.checkUuid);\n      }\n    }, (error) => {\n      console.error(\"Error testing datasource\", error);\n      throw new Error(\"Error testing data source, check the console\");\n    });\n  }\n\n  /* Find the metrics associated with our UUID of a specific kind */\n  metricFindQuery(query, kind) {\n    console.debug('Attempting to find metrics');\n\n    /* Return data cached up to 10 minutes */\n    let now = new Date().getTime();\n    if ((this.cache.metrics != null) && ((now - this.cache.timestamp) < 600000)) {\n      console.log('Returning metrics cached at ' + new Date(this.cache.timestamp).toISOString());\n      return Promise.resolve(this.cache.metrics[this.checkUuid] || []);\n    }\n\n    return this.doRequest({\n      url: this.url + '/raw/list_metrics',\n      method: 'GET',\n    }).then((response) => {\n\n      let metrics = {};\n      for (let metric of response.data.metrics) {\n        let match = metric.match(/^([0-9a-fA-F]{4}(?:[0-9a-fA-F]{4}-){4}[0-9a-fA-F]{12})-(.*)$/);\n        if (! match) continue;\n\n        let uuid = match[1];\n        let name = match[2];\n\n        let group = metrics[uuid];\n        if (! group) group = metrics[uuid] = [];\n\n        group.push(name);\n      }\n\n      console.log('Caching metrics from', response.data, 'as', metrics);\n      this.cache.metrics = metrics;\n      this.cache.timestamp = new Date().getTime();\n\n      return metrics[this.checkUuid] || [];\n    });\n  }\n\n  /* Query IronDB for the metric data */\n  query(options) {\n\n    console.log('QUERY', options);\n\n    let interval = options.intervalMs;\n    let start = options.range.from.valueOf();\n    let end = options.range.to.valueOf();\n\n    interval = Math.round(interval / 1000);\n    if (interval < this.minRollup) interval = this.minRollup;\n    start = Math.floor(start / 1000 / interval) * interval;\n    end = Math.ceil(end / 1000 / interval) * interval;\n\n    console.log('start =', start, 'end =', end, 'interval =', interval);\n\n    let promises = [];\n    for (let target of options.targets) {\n      let metric = this.templateSrv.replace(target.target, options.scopedVars, 'regex');\n      promises.push(this.fetchData(metric, target.type, start, end, interval));\n      console.log('TARGET', target);\n    }\n\n    return this.q.all(promises).then((data) => {\n      return { data: data }\n    });\n  }\n\n  annotationQuery(options) {\n    console.log(\"ANN\", options);\n\n    let start = Math.floor(options.range.from.valueOf() / 1000);\n    let end = Math.ceil(options.range.to.valueOf() / 1000);\n\n    let name = options.annotation.name || 'Annotation';\n    let query = (options.annotation.query || null);\n\n    if (! query) return this.q.resolve([]);\n\n    let url = this.url + '/read/' + start + '/' + end + '/' + this.checkUuid + '/' + query;\n\n    console.log(\"-->\", url, start, end, name, query);\n\n    return this.doRequest({\n      url: url,\n      method: 'GET',\n    }).then((response) => {\n      let data = [];\n\n      let regionId = 1;\n      let previousTrue = null;\n\n      for (let entry of response.data) {\n        let object = { title: name, time: entry[0], text: entry[1] };\n\n        if (object.text == 'true') {\n          previousTrue = object;\n        } else if ((object.text == 'false') && (previousTrue != null)) {\n          previousTrue.regionId = object.regionId = (regionId ++);\n          delete previousTrue.text;\n          delete object.text;\n        } else previousTrue = null;\n\n        data.push(object);\n      }\n      console.log(\"ANNOTATIONS\", data);\n      return data;\n    });\n  }\n\n  /* ======================================================================== */\n\n  fetchData(metric, type, start, end, interval) {\n\n    let url = type == 'text' ?\n              this.url + '/read/' + start + '/' + end + '/' + this.checkUuid + '/' + metric:\n              this.url + '/rollup/' + this.checkUuid + '/' + metric\n                       + '?start_ts=' + start\n                       + '&end_ts=' + end\n                       + '&rollup_span=' + interval + 's'\n                       + '&type=' + encodeURIComponent(type);\n    let multiplier = type == 'text' ? 1 : 1000;\n\n    let data = [];\n    let result = { target: metric, datapoints: data }\n    return this.doRequest({\n      url: url,\n      method: 'GET',\n    }).then((response) => {\n      console.log('RESPONSE', response.data);\n      for (let entry of response.data) {\n        data.push([ entry[1], entry[0] * multiplier]);\n      }\n      if (type == 'text') {\n        console.log('INJECTING', [ data[data.length - 1], end]);\n        data.push([ data[data.length - 1][0], end * 1000]);\n      }\n      console.log('FETCHING', url, result);\n      return result;\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n    //remove placeholder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'\n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"],"file":"datasource.js"}